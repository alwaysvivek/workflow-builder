{% extends "layout.html" %}

{% block content %}
<div class="history-container">
    <h1>Run History</h1>
    <p class="subtitle">Detailed logs of the last 5 workflow executions.</p>

    <div id="full-history-list">
        <p class="placeholder-text">Loading...</p>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', loadFullHistory);

    async function loadFullHistory() {
        const container = document.getElementById('full-history-list');
        try {
            const res = await fetch('/runs');
            const runs = await res.json();

            container.innerHTML = '';
            if (runs.length === 0) {
                container.innerHTML = '<p>No runs found.</p>';
                return;
            }

            runs.forEach(run => {
                const date = new Date(run.created_at).toLocaleString();

                // Build steps HTML
                let stepsHtml = '';
                if (run.step_runs && run.step_runs.length > 0) {
                    run.step_runs.forEach(step => {
                        stepsHtml += `
                        <div class="step-detail">
                            <strong>Step ${step.step_order} (${step.step_type}):</strong>
                            <pre>${step.output_text}</pre>
                        </div>
                    `;
                    });
                } else {
                    stepsHtml = '<p>No steps recorded.</p>';
                }

                const div = document.createElement('div');
                div.className = 'history-card-detailed';
                div.innerHTML = `
                <div class="history-header">
                    <span class="run-id">ID: ${run.id}</span>
                    <span class="run-date">${date}</span>
                    <span class="status-indicator ${run.status}">${run.status}</span>
                </div>
                <div class="history-body">
                    <div class="input-section">
                        <strong>Input:</strong>
                        <p>${run.input_text}</p>
                    </div>
                    <div class="steps-section">
                        ${stepsHtml}
                    </div>
                </div>
            `;
                container.appendChild(div);
            });

        } catch (e) {
            container.innerHTML = `<p class="error">Failed to load history: ${e.message}</p>`;
        }
    }
</script>

<style>
    .history-card-detailed {
        background: #fff;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        margin-bottom: 2rem;
        padding: 1.5rem;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
    }

    .history-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 1px solid #f3f4f6;
        padding-bottom: 1rem;
        margin-bottom: 1rem;
    }

    .run-id {
        font-family: monospace;
        color: #6b7280;
    }

    .run-date {
        color: #374151;
        font-weight: 500;
    }

    .input-section {
        background: #f9fafb;
        padding: 1rem;
        border-radius: 6px;
        margin-bottom: 1rem;
    }

    .input-section p {
        margin: 0.5rem 0 0;
        white-space: pre-wrap;
        color: #4b5563;
    }

    .step-detail {
        margin-top: 1rem;
        border-left: 3px solid #4F46E5;
        padding-left: 1rem;
    }

    .step-detail pre {
        background: #f8fafc;
        padding: 0.75rem;
        border-radius: 4px;
        overflow-x: auto;
        font-size: 0.9em;
        color: #334155;
    }
</style>
{% endblock %}